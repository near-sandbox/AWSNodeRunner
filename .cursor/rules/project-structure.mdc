---
description: Project organization, file structure, and directory patterns
globs:
  - "**/*"
alwaysApply: true
---

# Project Structure and Organization

Follow these patterns for organizing code, assets, and documentation.

## Directory Structure

```
lib/near/
├── app.ts                 # CDK application entry point
├── lib/                   # CDK stack implementations
│   ├── common-stack.ts   # Common resources (VPC, IAM, SG)
│   ├── infrastructure-stack.ts  # EC2 instance deployment
│   ├── install-stack.ts  # Installation validation
│   ├── sync-stack.ts     # Service validation and RPC
│   ├── test-stack.ts     # Functional test suite
│   └── config/           # Configuration modules
│       ├── localnet-config.ts
│       └── node-config.interface.ts
├── assets/               # Assets deployed to Lambda/S3
│   ├── near-localnet-setup.sh
│   └── test-suite/       # Test Lambda assets
├── scripts/              # Utility scripts
│   ├── export-config.ts
│   └── trigger-tests.ts
├── test/                 # Jest unit tests
├── docs/                 # Documentation
│   ├── CROSS_CHAIN_INTEGRATION.md
│   └── LOCALNET_SERVICES.md
├── dist/                 # Compiled TypeScript (generated)
└── cdk.out/             # CDK synthesis output (generated)
```

## File Organization Patterns

### Stack Files

- One stack per file: `{stack-name}-stack.ts`
- Co-locate stack-specific interfaces in same file
- Export stack class and props interface

**Pattern:**
```typescript
// infrastructure-stack.ts
export interface NearInfrastructureStackProps extends cdk.StackProps { /* ... */ }
export class NearInfrastructureStack extends cdk.Stack { /* ... */ }
```

### Configuration Files

- Configuration modules in `lib/config/`
- Types/interfaces: `node-config.interface.ts`
- Implementation: `localnet-config.ts`
- Export config objects and types

### Asset Files

- Shell scripts: `assets/` directory
- Deployed to Lambda or EC2 via CDK assets
- Include README.md for asset documentation

**Example:**
```
assets/test-suite/
├── bootstrap          # Lambda handler entry
├── handler.py        # Python test handler
├── utils.sh          # Utility functions
└── README.md         # Asset documentation
```

### Script Files

- Utility scripts: `scripts/` directory
- TypeScript source with compiled output in `dist/scripts/`
- Use `ts-node` for direct execution or compile first

## Naming Conventions

### Files and Directories

- **Stacks**: `{name}-stack.ts` (kebab-case for file, PascalCase for class)
- **Config**: `{name}-config.ts` (kebab-case)
- **Tests**: `{name}.test.ts` (kebab-case for file)
- **Assets**: Descriptive names with hyphens
- **Scripts**: `{action}-{target}.ts` (e.g., `export-config.ts`)

### TypeScript Modules

- **Classes**: `PascalCase` (e.g., `NearInfrastructureStack`)
- **Interfaces**: `PascalCase` (e.g., `NearBaseNodeConfig`)
- **Constants**: `UPPER_SNAKE_CASE` (e.g., `AWS_REGION`)
- **Variables**: `camelCase` (e.g., `instanceId`, `vpc`)
- **Stack names**: `near-localnet-{type}` (e.g., `near-localnet-common`)

### AWS Resources

- **Stack names**: `near-localnet-{type}` (CloudFormation stack name)
- **Construct IDs**: `PascalCase` (e.g., `NearLocalnetNode`)
- **Export names**: `NearLocalnet{Resource}` (e.g., `NearLocalnetInstanceId`)

## Module Organization

### Imports Order

1. Node.js built-ins
2. External packages (CDK, constructs)
3. AWS CDK modules (`aws-cdk-lib`, sub-modules)
4. Local relative imports (config, stacks)

**Pattern:**
```typescript
import "source-map-support/register";  // Source map support
import * as cdk from "aws-cdk-lib";    // CDK core
import * as ec2 from "aws-cdk-lib/aws-ec2";  // CDK modules
import * as config from "./config/localnet-config";  // Local imports
```

### Export Patterns

- Export classes and interfaces used by other modules
- Export config objects and types
- Use default exports sparingly (prefer named exports)
- Group related exports

## Documentation Structure

### README Files

- Main README: `README.md` (project overview, deployment instructions)
- Asset READMEs: `assets/*/README.md` (asset-specific docs)
- Doc files: `docs/*.md` (detailed guides)

### Code Documentation

- JSDoc comments for public APIs
- Inline comments for complex logic
- Document NEAR-specific and AWS-specific patterns

## Generated Files

### TypeScript Output

- Compiled JavaScript: `dist/` directory
- Type definitions: `dist/**/*.d.ts`
- Source maps: Inline (`inlineSourceMap: true`)

### CDK Output

- CloudFormation templates: `cdk.out/`
- CDK assets: `cdk.out/asset.*/`
- Nag reports: `cdk.out/AwsSolutions-*-NagReport.csv`

### Gitignore Patterns

**Exclude from version control:**
- `node_modules/`
- `dist/` (compiled output)
- `cdk.out/` (CDK synthesis)
- `.env*.local` (local environment files)

**Include in version control:**
- `*.d.ts` (type definitions)
- `tsconfig.json` (TypeScript config)
- `jest.config.js` (test config)
- `package.json` and `package-lock.json`

## Cross-Module References

### Stack Dependencies

- Pass resources directly: `vpc`, `securityGroup`, `instanceRole`
- Use `stack.addDependency()` for ordering
- Export values via `CfnOutput` for cross-stack references

### Configuration Access

- Import from `lib/config/localnet-config`
- Use types from `lib/config/node-config.interface`
- Access via: `config.localnetConfig`, `config.baseConfig`

**Pattern:**
```typescript
import * as config from "./lib/config/localnet-config";
import * as configTypes from "./lib/config/node-config.interface";

const instanceType = config.localnetConfig.instanceType;
const nearNetwork: configTypes.NearNetwork = config.baseConfig.nearNetwork;
```

## Asset Deployment

### Lambda Assets

- Package in `assets/test-suite/`
- Reference in CDK: `new lambda.Code.fromAsset('assets/test-suite')`
- Include bootstrap script for Lambda runtime

### EC2 UserData

- Scripts embedded in stack code (not separate files)
- Use `ec2.UserData.forLinux()` with `addCommands()`
- Log all output for debugging

**Reference:** See @app.ts for application structure and @lib/ for stack organization patterns.